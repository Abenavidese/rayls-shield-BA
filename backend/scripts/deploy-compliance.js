const hre = require("hardhat");
const fs = require("fs");
const path = require("path");

async function main() {
  console.log("\nðŸš€ Deploying Compliance Verifier to Rayls Devnet...\n");

  const [deployer] = await hre.ethers.getSigners();
  console.log("Deploying with account:", deployer.address);

  const balance = await hre.ethers.provider.getBalance(deployer.address);
  console.log("Account balance:", hre.ethers.formatEther(balance), "USDgas\n");

  // Deploy ComplianceVerifier (auto-generated by circom as "Verifier")
  console.log("ðŸ“ Deploying ComplianceVerifier (Verifier contract)...");
  const ComplianceVerifier = await hre.ethers.getContractFactory("contracts/ComplianceVerifier.sol:Verifier");
  const complianceVerifier = await ComplianceVerifier.deploy();
  await complianceVerifier.waitForDeployment();
  const complianceVerifierAddress = await complianceVerifier.getAddress();

  console.log("âœ… ComplianceVerifier deployed to:", complianceVerifierAddress);

  // Load existing deployment
  const deploymentPath = path.join(__dirname, "../deployments/raylsDevnet.json");
  let deployment = {};

  if (fs.existsSync(deploymentPath)) {
    deployment = JSON.parse(fs.readFileSync(deploymentPath, "utf8"));
  }

  // Update deployment with ComplianceVerifier
  deployment.contracts = deployment.contracts || {};
  deployment.contracts.ComplianceVerifier = complianceVerifierAddress;
  deployment.timestamp = new Date().toISOString();

  // Save deployment info
  fs.writeFileSync(deploymentPath, JSON.stringify(deployment, null, 2));
  console.log("\nðŸ’¾ Deployment info saved to:", deploymentPath);

  // Display deployment summary
  console.log("\nðŸ“Š Deployment Summary:");
  console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
  console.log("Network:              Rayls Devnet");
  console.log("Chain ID:             123123");
  console.log("ComplianceVerifier:  ", complianceVerifierAddress);
  console.log("Deployer:            ", deployer.address);
  console.log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n");

  console.log("ðŸ”— View on Explorer:");
  console.log(`https://devnet-explorer.rayls.com/address/${complianceVerifierAddress}\n`);

  console.log("âœ… Compliance deployment complete!\n");
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
